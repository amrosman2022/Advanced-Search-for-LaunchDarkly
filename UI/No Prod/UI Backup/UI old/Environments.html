<html>
    <head>
        <meta charset="utf-8">
        <title>Search Environments</title>
        <link rel="stylesheet" href="./CSS/table.css">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    </head>
    <script type="text/javascript" src="./DynaTable/ArrayToTable.js" ></script>
   

    <script>
        // ----------------------------------------------
        // --------Common function: XML to Array --------
        // ----------------------------------------------
        function convertXmlToArray(xmlStr) 
        {
            const jsArray = JSON.parse(xmlStr);
            return jsArray;
        }

        // ----------------------------------------------
        // ------------- UI: Submit List or Search ------
        // ----------------------------------------------
        function func_selector ()
        {
            bol_srchAll = document.getElementById('LAP').style.color == 'green';
            if (bol_srchAll == true)
            {
                getListofEnv();
            }
            else 
            {
                getSrchEnv();
            }
        }

        // ---------------------------------------------
        // -----UI: Show/Hide All the search Form ------
        // ----------------------------------------------
        function func_toggleDivState (me, s_element,)
        {
            state = document.getElementById(s_element);
            document.getElementById("form_search").reset();
            if (me.id == "LAP")
            {
                state.style.display = "none";
                document.getElementById("LAP").style.color="green";
                document.getElementById("SAP").style.color="Gray";
            }
            else
            {
                state.style.display = "block";
                document.getElementById("SAP").style.color="green";
                document.getElementById("LAP").style.color="Gray";
            }
        }

        // ----------------------------------------------
        // -----------UI: Show/Hide Form Field-----------
        // ----------------------------------------------
        function func_toggleElementState (me, s_element)
        {
            state = document.getElementById(s_element);
            if (me.checked == true)
            {
                state.disabled = false;
            }
            else
            {
                state.disabled = true;
            }
        }

        // ----------------------------------------------
        // ------------MAIN: List All Envects-----------
        // ----------------------------------------------
        const getListofEnv = async () => 
        {
            document.getElementById('EnvList').innerHTML = '';
            const response = await fetch('http://localhost:8080/list|||environments|||' + document.getElementById('n_Max_Cnt').value);
            const myJson = await response.text(); //extract TEXT from the http response
            //document.getElementById('EnvList').innerHTML += myJson;

            //-------------------------------------------------------------------
            // ---------------- Convert the JSON to JS Array --------------------
            //-------------------------------------------------------------------
            myArray = convertXmlToArray(myJson);
            //--------------------------------------------------------------------------------
            // - Call the function to write the JS Array into a HTML Table and insert on page -
            //---------------------------------------------------------------------------------
            var tableGen = new ArrayToTable();
            tableGen.replaceRules = {"s_proj_id":"Project ID", "s_env_id":"Environment ID", "s_env_data":"Environment JSON Details", "s_env_tags":"Tags"}
            tableGen.tableclasses = 'bluetable table-with-oddeven';
            tableGen.tableid = 'tbl_envlist';
            tableGen.putTableHtmlToId(myArray, 'EnvList', 's_proj_id, s_env_id, s_env_tags');
        }

        // ----------------------------------------------
        // ----------MAIN: Search All Environments-----------
        // ----------------------------------------------
        const getSrchEnv = async () => 
        {
            const forms = document.querySelectorAll('form');
            const form = forms[1];
            s_srchStr = '';
            s_srchVal = '';
            s_URL = '';
            cnt = 0;

            //---------------------------------------------------------
            
            //---------------------------------------------------------
            document.getElementById('EnvList').innerHTML = '';

            //-----------------------------------------------------------------------------
            // ------ Cycle through the form fields and Create the URL search  ------------
            //-----------------------------------------------------------------------------
            Array.from(form.elements).forEach((input) => 
            {
                if (input.id.substring(0,4) != 'skip')
                {
                    if (document.getElementById("skip_"+input.id).checked == true)
                    {
                        if (cnt>0)
                        {
                            if (input.type == 'checkbox') //* value inside the input field to search aginest = Right side of the equation
                            {
                                s_srchVal += ',' + input.checked;
                            }
                            else{
                                s_srchVal += ',"' + input.value;
                            }
                            s_srchStr += ',' + input.id + '":'; //* the field name to search for in LD = Left side of the equation
                            cnt++;
                        }
                        else 
                        {
                            if (input.type == 'checkbox') //* value inside the input field to search aginest = Right side of the equation
                            {
                                s_srchVal += input.checked;
                            }
                            else{
                                s_srchVal += '"' + input.value;
                            }
                            s_srchStr += input.id + '":'; //* the field name to search for in LD = Left side of the equation
                            cnt++;
                        }
                    }
                }
            });
            //-----------------------------------------------------------------------------
            // ------------ Execute the search URL and return an JSON Array ---------------
            //-----------------------------------------------------------------------------

            s_URL = 'http://localhost:8080/search|||environments' + '|||' + document.getElementById('n_Max_Cnt').value + '|||' + s_srchStr + '|||' + s_srchVal;
           
            const response = await fetch(s_URL);
            const myJson = await response.text() // .text(); //extract TEXT from the http response

            //-------------------------------------------------------------------
            // ---------------- Convert the JSON to JS Array --------------------
            //-------------------------------------------------------------------
            myArray = convertXmlToArray(myJson);
            //var JSONobj = JSON.parse(myArray[0]['s_Env_data']);
            //html_Output = formatJsonToHtml(JSONobj);
            //--------------------------------------------------------------------------------
            // - Call the function to write the JS Array into a HTML Table and insert on page -
            //---------------------------------------------------------------------------------
            var tableGen = new ArrayToTable();
            tableGen.replaceRules = {"s_proj_id":"Project ID", "s_env_id":"Environment ID", "s_env_data":"Environment JSON Details", "s_env_tags":"Tags"}
            tableGen.tableclasses = 'bluetable table-with-oddeven';
            tableGen.tableid = 'something-unique';
            //var tableGen = new ArrayToTable();
            tableGen.putTableHtmlToId(myArray, 'EnvList', 's_proj_id, s_env_id, s_env_tags');
        }
    // *********************************************************************************************************
    </script>
<Body>
     <!-- the hidden modal DIV to show the JSON details -->
     <div id="myModal" class="modal">
        <div class="modal-content">
            <span onclick="document.getElementById('myModal').style.display='none';" class="close">&times;</span>
            <p id="myModalContent"></p>
        </div>
    </div>     
    <!----------------------------------------------------> 
    <div id="Env">Environments</div>
    <!--getFlagCnt();-->
    <script></script>
    <form id="form_selector">
        <input type="button" value="List All Environments" id="LAP" style="color:green;" onclick="func_toggleDivState(this,'div_searchcrit')"><BR>
        <input type="button" value="Search Environments" id="SAP" style="color:gray;" onclick="func_toggleDivState(this,'div_searchcrit')"><BR>
        <label>Max Rows Returned (0=Max): </label><input id="n_Max_Cnt" type="text" value="2"><BR>
        <input type="button" value="Search" type="button" onclick="func_selector ();">
    </form>

    <div id="div_searchcrit" style="display:none;">
        <form id="form_search">
            <input type="checkbox" id="skip_key" value=true checked onchange="func_toggleElementState(this,'key')"> 
            <label>Environment ID </label><input id="key" type="text" width="100px">
                <BR>
            <input type="checkbox" id="skip_defaultTtl" value=true checked onchange="func_toggleElementState(this,'defaultTtl')"> 
            <label id="ttlval">Default TTL 50</label><input id="defaultTtl" type="range" min="1" max="100" value="50" oninput="document.getElementById('ttlval').innerText = 'Default TTL ' + this.value;">
                <BR>
            <input type="checkbox" id="skip_secureMode" value=true checked onchange="func_toggleElementState(this,'secureMode')"> 
            <label>Secure Mode</label><input id="secureMode" type="checkbox" class="toggle" value="false">
                <BR>
            <input type="checkbox" id="skip_requireComments" value=true checked onchange="func_toggleElementState(this,'requireComments')"> 
            <label>Require Comments</label><input id="requireComments" type="checkbox" class="toggle" value="false">
                <BR>
            <input type="checkbox" id="skip_confirmChanges" value=true checked onchange="func_toggleElementState(this,'confirmChanges')"> 
            <label>Require Confirmation</label><input id="confirmChanges" type="checkbox" class="toggle" value="false">
                <BR>
            <input type="checkbox" id="skip_defaultTrackEvents" value=true checked onchange="func_toggleElementState(this,'defaultTrackEvents')"> 
            <label>Data Export Enabled</label><input id="defaultTrackEvents" type="checkbox" class="toggle" value="false">
                <BR>
            <!--<input type="checkbox" id="skip_tags" value=true checked onchange="func_toggleElementState(this,'tags')"> 
            <label>Tags </label><input id="tags" type="text" width="100px">
                <BR>-->
        </form>
    </div>
    <div id="EnvList">

    </div>
</body>
</html>